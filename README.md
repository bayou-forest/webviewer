# webviewer
web viewer


# 以下の仕様を満たすwebアプリケーションプログラムを作成してください。
 
## 要件

1枚のページからなるwebアプリケーションである。
アプリケーションルート以下にある、画像・動画ファイルを一覧で表示し、スマホ端末、PC端末からアクセスし、表示・再生できる。
アプリケーションルート以下のフォルダを再探索するための更新ボタンを用意する。
サブフォルダ内のファイルも表示するかどうかは、チェックボックスで指定できる。
動画、画像ファイルはサムネイルが表示される。
動画にマウスオーバーすると、サムネイルのサイズで、動画のキーフレームが順次表示される。（部分が順次表示されれば、キーフレームでなくてもいい。）
初期表示では、サムネイルのみが表示され、動画のデータは端末に読み込まれない。
ローカルネットワークにある別端末からアクセスできるようにする。
動画のサムネイル(キーフレーム表示も含む)はあらかじめ作成しておく。動画の開始から10秒程度のところを初期表示されるサムネイル画像として使用する。
アプリケーション起動時と、更新ボタン押下時に、ファイルの追加、削除を検出し、表示内容を更新する。
ファイル1つずつには個別のURLが割り当てられ、クリックすると、そのURLに遷移し、画像・動画がフルサイズで表示・再生される。
各ファイルには、高評価／低評価ボタンがあり、クリックすると、そのファイルに対する評価が登録される。クリック回数に制限はない。
評価は数値として管理し、0からスタートし、高評価ボタン押下で+1、低評価ボタン押下で-1される。
評価はファイルごとに保存され、アプリケーション再起動後も保持される。
高評価のみを表示するフィルターボタンを用意する。
低評価のファイルパスを一覧出力するボタンを用意する。

## 概要設計

pythonでflaskを使ってローカルサーバーを立てる。
アプリケーション起動時に、起動ルート配下に _metadata というフォルダを作成し、そこにサムネイルや、評価データを保存する。
_metadataフォルダが存在しない場合、コンソールで確認の上、作成する。
_metadataフォルダが存在し（または作成直後）、その中に関連ファイルやディレクトリがない場合、必要なものを作成する。
各動画ファイルのファイルハッシュ値を計算し、それをキーにして、サムネイル画像や評価データを保存する。
ファイルパスが異なる、ハッシュが同一のファイルが存在する場合にも対応できるようにする。（その場合、同一ファイルとみなし、サムネイルや評価は共通としてよい。）
評価データはsqlite3データベースに保存する。


次のとおり仕様を追加・変更してください

1. 動画の長さを取得して、データとして保存してください。一覧のファイルサイズの横に動画の長さを表示してください。
2. 動画の長さを考慮して、サムネイル生成のオフセット時間を調整してください。動画の長さが PREVIEW_START_SECONDS 未満の場合、動画の長さの10%の時間をオフセット時間としてください。(開始から10%過ぎたところをサムネに使う、ということ)
3. 同様に、動画の長さを考慮して、プレビュー画像のオフセット時間も調整してください。
   動画の長さを VIDEO_PREVIEW_COUNT で割り、それをオフセット時間としてください。（60秒の動画なら,10秒おきに6枚のプレビュー画像を生成する、ということ）
4. 動画のサムネイル生成、プレビュー画像生成に失敗した場合、空のファイルを作成し、次回以降の生成をスキップするようにしてください。
5. 一覧にファイル名が二重に表示されています。（ファイル名とパス、ルートにある場合は同じなので。）ファイル名のみでよいです。


- 再生回数をカウントできるように修正してください。
   再生回数は、詳細画面を開いた後再生ボタンを押したとき、非同期でサーバに送信し、カウントしてください。
   カウントした値は評価と同様、DBに保存してください。
   また、詳細画面で複数回再生が押された場合、1回以上カウントしないようにしてください。（ただし、再度詳細画面を開き、再生を押したときは再カウントしてよい）
   再生回数は一覧画面と詳細画面の両方に表示して下さい。
- フィルタに、再生回数0、0以上の選択肢を追加してください。
- 詳細画面に高評価・低評価ボタンを追加してください。

再生回数が0回のものはサムネ画面の枠の色が変わるようにしてください。いまは黒のみですが、少し明るくなるように

## ファイル削除時の挙動について

対象ディレクトリから動画・画像ファイルが削除された場合の挙動は以下のとおりです：

### Web画面の一覧表示
- ファイル削除後、更新ボタンを押すと一覧から削除されます
- 実際にディスク上に存在するファイルのみが表示されます

### メタデータの保持
以下のデータは削除されず、保持され続けます：

1. **サムネイル画像**: `_metadata/thumbnails/` に残ります
2. **プレビュー画像**: `_metadata/previews/` に残ります（動画の場合）
3. **評価スコア**: SQLiteデータベース(`_metadata/ratings.sqlite3`)に残ります
4. **再生回数**: SQLiteデータベースに残ります

### 設計意図
この仕様は以下の理由により意図的なものです：
- ファイルを一時的に移動した場合でも、評価・再生回数などのメタデータを保持できる
- 同じファイル（同一ハッシュ値）を後日追加した場合、過去のメタデータを再利用できる
- ファイル管理のミスによるメタデータ消失を防ぐ

メタデータのクリーンアップが必要な場合は、`_metadata` フォルダを手動で削除してください。
